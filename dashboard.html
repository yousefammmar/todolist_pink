<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Task & Notes Manager</title>
    <link rel="stylesheet" href="style.css">
    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="storage.js"></script>
</head>

<body>
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
            <h1 style="margin: 0; flex: 1;">Welcome, <span id="user-name">User</span>!</h1>
            <a href="about.html" class="btn btn-secondary" style="margin-left: auto; margin-right: 0.5rem;"
                aria-label="About our team">About Us</a>
        </div>
        <nav>
            <a href="index.html" class="btn btn-primary" aria-label="Go to homepage">Home</a>
            <a href="task_history.html" class="btn btn-info" aria-label="View task history">Task History</a>
            <a href="profile.html" class="btn btn-warning" aria-label="Go to profile settings">Profile</a>
            <a href="#" id="logout-btn" class="btn btn-danger" aria-label="Logout from your account">Logout</a>
        </nav>
    </header>

    <main>
        <div class="container dashboard-container">
            <!-- Tasks Manager Section -->
            <section class="tasks-section">
                <h2>Tasks Manager</h2>
                <p>Manage your tasks. Only tasks that are not completed are shown here.</p>

                <!-- Add Task Form -->
                <form id="addTaskForm" class="task-form">
                    <input type="text" id="taskInput" placeholder="Enter task..." required aria-label="Enter new task">
                    <button type="submit" class="btn btn-primary" aria-label="Add new task">Add Task</button>
                </form>

                <!-- React TaskList Component will render here -->
                <div id="tasks-root"></div>
            </section>

            <!-- Notes Manager Section -->
            <section class="notes-section">
                <h2>Notes Manager</h2>
                <p>Add and manage your notes.</p>

                <!-- Add Note Form -->
                <form id="addNoteForm" class="note-form">
                    <input type="text" id="noteInput" placeholder="Write a short note..." required
                        aria-label="Enter new note">
                    <button type="submit" class="btn btn-primary" aria-label="Add new note">Add Note</button>
                </form>

                <!-- Notes List -->
                <ul class="notes-list" id="notesList">
                    <!-- Loaded via JS -->
                </ul>
            </section>
        </div>
    </main>

    <footer>
        <p>&copy; <span id="year"></span> To-Do & Notes Manager. All rights reserved.</p>
    </footer>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // TaskList React Component
        function TaskList() {
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);

            const fetchTasks = () => {
                const allItems = StorageService.getUserItems();
                const notDoneTasks = allItems.filter(item =>
                    item.type === 'task' && item.status !== 'completed'
                );
                setTasks(notDoneTasks);
                setLoading(false);
            };

            useEffect(() => {
                fetchTasks();
                // Listen for storage changes in same window (for dynamic updates if needed)
                window.addEventListener('storage-updated', fetchTasks);
                return () => window.removeEventListener('storage-updated', fetchTasks);
            }, []);

            const handleStatusChange = (taskId, newStatus) => {
                StorageService.updateItem(taskId, { status: newStatus });
                fetchTasks();
                // Trigger event for notes if they were in the same storage (though not needed here)
            };

            const handleDelete = (taskId) => {
                if (!confirm('Are you sure you want to delete this task?')) return;
                StorageService.deleteItem(taskId);
                fetchTasks();
            };

            const handleEdit = (taskId, newContent) => {
                StorageService.updateItem(taskId, { content: newContent });
                fetchTasks();
            };

            if (loading) return <p>Loading tasks...</p>;
            if (tasks.length === 0) return <p className="placeholder">No tasks yet. Add a task to get started!</p>;

            return (
                <ul class="task-list">
                    {tasks.map(task => (
                        <TaskItem
                            key={task.id}
                            task={task}
                            onStatusChange={handleStatusChange}
                            onDelete={handleDelete}
                            onEdit={handleEdit}
                        />
                    ))}
                </ul>
            );
        }

        function TaskItem({ task, onStatusChange, onDelete, onEdit }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editValue, setEditValue] = useState(task.content);
            const currentStatus = task.status || 'pending';

            const handleSave = () => {
                onEdit(task.id, editValue);
                setIsEditing(false);
            };

            const getStatusBadge = (status) => {
                const statusMap = {
                    'pending': { text: 'Pending', class: 'status-pending' },
                    'in_progress': { text: 'In Progress', class: 'status-in-progress' },
                    'completed': { text: 'Done', class: 'status-completed' }
                };
                const statusInfo = statusMap[status] || statusMap['pending'];
                return <span className={`status-badge ${statusInfo.class}`}>{statusInfo.text}</span>;
            };

            const getNextStatus = (current) => {
                if (current === 'pending') return 'in_progress';
                if (current === 'in_progress') return 'completed';
                return current;
            };

            return (
                <li className="task-item">
                    {isEditing ? (
                        <div className="edit-form">
                            <input
                                type="text"
                                value={editValue}
                                onChange={(e) => setEditValue(e.target.value)}
                                aria-label="Edit task"
                            />
                            <button onClick={handleSave} className="btn btn-success btn-sm">Save</button>
                            <button onClick={() => setIsEditing(false)} className="btn btn-secondary btn-sm">Cancel</button>
                        </div>
                    ) : (
                        <>
                            <div className="task-content">
                                <div className="task-text">
                                    <span>{task.content}</span>
                                </div>
                                {getStatusBadge(currentStatus)}
                            </div>
                            <div className="task-actions">
                                {currentStatus !== 'completed' && (
                                    <button
                                        onClick={() => onStatusChange(task.id, getNextStatus(currentStatus))}
                                        className="btn btn-info btn-sm"
                                        aria-label="Change task status"
                                    >
                                        {currentStatus === 'pending' ? 'Start' : 'Mark Done'}
                                    </button>
                                )}
                                <button onClick={() => setIsEditing(true)} className="btn btn-warning btn-sm" aria-label="Edit task">Edit</button>
                                <button onClick={() => onDelete(task.id)} className="btn btn-danger btn-sm" aria-label="Delete task">Delete</button>
                            </div>
                        </>
                    )}
                </li>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('tasks-root'));
        root.render(<TaskList />);
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const user = StorageService.getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('user-name').textContent = user.name;
            document.getElementById('year').textContent = new Date().getFullYear();

            document.getElementById('logout-btn').addEventListener('click', function (e) {
                e.preventDefault();
                StorageService.logout();
                window.location.href = 'index.html';
            });

            // Add Task
            document.getElementById('addTaskForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const taskInput = document.getElementById('taskInput');
                const content = taskInput.value.trim();
                if (content) {
                    StorageService.saveItem({ type: 'task', content: content });
                    taskInput.value = '';
                    window.dispatchEvent(new Event('storage-updated'));
                }
            });

            // Add Note
            document.getElementById('addNoteForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const noteInput = document.getElementById('noteInput');
                const content = noteInput.value.trim();
                if (content) {
                    StorageService.saveItem({ type: 'note', content: content });
                    noteInput.value = '';
                    loadNotes();
                }
            });

            function loadNotes() {
                const items = StorageService.getUserItems().filter(i => i.type === 'note');
                const notesList = document.getElementById('notesList');

                if (items.length === 0) {
                    notesList.innerHTML = '<li class="placeholder">No notes yet.</li>';
                } else {
                    notesList.innerHTML = items.reverse().map(note => `
                        <li data-note-id="${note.id}">
                            <span>${escapeHtml(note.content)}</span>
                            <button type="button" class="btn btn-danger btn-sm delete-note" data-id="${note.id}" aria-label="Delete note">Delete</button>
                        </li>
                    `).join('');

                    attachDeleteListeners();
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function attachDeleteListeners() {
                document.querySelectorAll('.delete-note').forEach(button => {
                    button.addEventListener('click', function () {
                        if (confirm('Are you sure you want to delete this note?')) {
                            StorageService.deleteItem(this.dataset.id);
                            loadNotes();
                        }
                    });
                });
            }

            loadNotes();
        });
    </script>
</body>

</html>